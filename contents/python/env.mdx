---
title: 环境变量
---

**准确地说，这是 pytest 的「命令行参数注入」**

这就是 pytest 配置系统（数据）的两个部分：

---

## 两部分配合工作

### 第一部分：**程序定义**（在代码中）

```python
def pytest_addoption(parser):
    parser.addoption(
        "--env",           # 定义选项名称
        action="store",    # 定义选项行为
        default="test",    # 定义默认值
        help="测试环境: test, staging, prod"  # 定义帮助文本
    )
    parser.addoption(
        "--slow",
        action="store_true",  # 布尔标志，不需要值
        help="运行慢速测试"
    )

```

### 第二部分：**命令行使用**（在终端中）

```bash
pytest --env=test          # 设置环境为test
pytest --env=staging       # 设置环境为staging
pytest --env=prod --slow   # 设置环境为prod并启用慢速测试
pytest --slow              # 只启用慢速测试，env使用默认值test

```

---

## 两种选项类型的区别

### 1. **存储值选项** (`action="store"`)

```python
parser.addoption(
    "--env",
    action="store",      # 存储传入的值
    default="test",      # 默认值
    help="测试环境"
)

```

**使用**：

```bash
pytest --env=staging     # 存储字符串"staging"
pytest --env=prod        # 存储字符串"prod"

```

### 2. **布尔标志选项** (`action="store_true"`)

```python
parser.addoption(
    "--slow",
    action="store_true",  # 存在即为True，不存在即为False
    help="运行慢速测试"
)

```

**使用**：

```bash
pytest --slow           # slow = True
pytest                  # slow = False (默认)

```

---

## 完整的工作流程示例

### 1. 在 `conftest.py` 中定义选项

```python
# conftest.py
def pytest_addoption(parser):
    parser.addoption(
        "--env",
        action="store",
        default="test",
        choices=["test", "staging", "prod"],  # 可选：限制可选值
        help="选择测试环境"
    )
    parser.addoption(
        "--slow",
        action="store_true",
        help="是否运行慢速测试"
    )

```

### 2. 在测试中使用这些选项

```python
# test_example.py
import pytest

@pytest.fixture
def api_base_url(request):
    env = request.config.getoption("--env")

    base_urls = {
        "test": "<https://test.api.com>",
        "staging": "<https://staging.api.com>",
        "prod": "<https://api.com>"
    }
    return base_urls[env]

def test_api_connection(api_base_url):
    print(f"连接到: {api_base_url}")
    # 测试逻辑...

@pytest.mark.slow
def test_slow_operation(request):
    # 只有 --slow 参数存在时才运行
    if not request.config.getoption("--slow"):
        pytest.skip("跳过慢速测试 (使用 --slow 运行)")

    print("执行耗时操作...")

```

### 3. 各种使用方式

```bash
# 基本用法（使用默认值）
pytest

# 指定环境
pytest --env=staging

# 运行慢速测试
pytest --slow

# 组合使用
pytest --env=prod --slow

# 查看帮助（会显示你定义的help文本）
pytest --help

```

---

## 更多选项类型

除了这两种，还有其他类型：

```python
def pytest_addoption(parser):
    # 存储值（默认）
    parser.addoption("--env", action="store", default="test")

    # 布尔标志
    parser.addoption("--slow", action="store_true")

    # 存储常量值
    parser.addoption("--verbose", action="store_const", const=2, default=1)

    # 追加多个值
    parser.addoption("--include", action="append", default=[])

    # 计数（出现次数）
    parser.addoption("--verbose", action="count", default=0)

```

---

## 总结

你的理解完全正确：

- **`pytest_addoption`**：在代码中**定义**有哪些选项
- **`pytest --env=test`**：在命令行中**使用**这些选项

这样就建立了一个灵活的配置系统，让同一套测试代码可以在不同配置下运行！

夹具在获得时候，这么获取

```tsx
@pytest.fixture
def calculator(request):
     # request 包含了测试的上下文信息
    print(request.config.getoption("--env"))
```