---
title: è£…é¥°å™¨
---

è£…é¥°å™¨ï¼ˆdecoratorï¼‰æ˜¯ä¸­çš„ä¸€ç§é«˜çº§åŠŸèƒ½ï¼Œæ˜¯ Python çš„ä¸€ç§ç¨‹åºè®¾è®¡æ¨¡å¼ï¼Œè£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª å‡½æ•°æˆ–ç±»ã€‚

å®ƒå¯ä»¥è®©å…¶ä»–å‡½æ•°æˆ–ç±»ï¼Œåœ¨ä¸éœ€è¦åšä»»ä½•ä»£ç ä¿®æ”¹çš„å‰æä¸‹å¢åŠ é¢å¤–åŠŸèƒ½ï¼Œè£…é¥°å™¨çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°æˆ–ç±»å¯¹è±¡ã€‚

æœ‰äº†è£…é¥°å™¨ï¼Œå°±å¯ä»¥æŠ½ç¦»ä¸å‡½æ•°åŠŸèƒ½æœ¬èº«æ— å…³çš„ä»£ç ï¼Œæ”¾åˆ°è£…é¥°å™¨ä¸­å¹¶ç»§ç»­é‡å¤ä½¿ç”¨ï¼

```mermaid
graph TD
    A[åŸå‡½æ•°/ç±»] --> B[è£…é¥°å™¨] --> C[æ–°å‡½æ•°/ç±»]
```

{/* è£…é¥°å™¨çš„è¯­æ³•ä½¿ç”¨ `@è£…é¥°å™¨å` æ¥åº”ç”¨åœ¨å‡½æ•°æˆ–æ–¹æ³•ä¸Šã€‚ */}

## å®šä¹‰ä¸ä½¿ç”¨

```py
# å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨
def my_decorator(func):
    def wrapper():
        print("åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ")
        func()
        print("åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ")
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨
@my_decorator
def my_fun():
    print("è¿™æ˜¯åŸå‡½æ•°")

my_fun()

# æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
# åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ
# è¿™æ˜¯åŸå‡½æ•°
# åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ
```
- my_decorator æ˜¯è£…é¥°å™¨ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ã€‚
- wrapper æ˜¯å†…éƒ¨å‡½æ•°ï¼Œå®ƒæ˜¯å®é™…ä¼šè¢«è°ƒç”¨çš„æ–°å‡½æ•°ï¼Œå®ƒåŒ…è£¹äº†åŸå§‹å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶åœ¨å…¶å‰åå¢åŠ äº†é¢å¤–çš„è¡Œä¸ºã€‚
- Python ä¼šè‡ªåŠ¨å°† my_fun ä½œä¸ºå‚æ•°ä¼ é€’ç»™ my_decoratorï¼Œç„¶åå°†è¿”å›çš„ wrapper å‡½æ•°æ›¿æ¢æ‰åŸæ¥çš„ my_funã€‚


## å¸¦å‚æ•°

è‹¥ç›®æ ‡å‡½æ•°éœ€å‚æ•°ï¼Œå¯åœ¨è£…é¥°å™¨çš„ wrapper å‡½æ•°ä¸­ä¼ é€’

```python
def my_decorator(func):
    def wrapper(*args, **kwargs):
        print("åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ")
        func(*args, **kwargs)
        print("åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ")
    return wrapper

@my_decorator
def say_hello(msg):
    print(msg)

say_hello("Hello, World!")

# æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
# Hello, World!
```

è£…é¥°å™¨æœ¬èº«ä¹Ÿå¯ä»¥æ¥å—å‚æ•°ï¼Œæ­¤æ—¶éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ªå¤–å±‚å‡½æ•°ï¼ˆæ—¢è£…é¥°å™¨å·¥å‚ï¼‰æ¥æ¥æ”¶è¿™äº›å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼ˆğŸª† å¥—å¨ƒä¹ˆï¼‰ã€‚

```py
def repeat(num):
    def decorator(func):
        def wrapper(*args, **kwargs):
            for _ in range(num):
                func(*args, **kwargs)
        return wrapper
    return decorator

@repeat(2)
def say_hello(msg):
    print(msg)

say_hello("Hello, World!")

# æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
# Hello, World!
# Hello, World!
```

## åˆ†ç±»
æŒ‰ç…§è£…é¥°å™¨çš„**åº”ç”¨ç›®æ ‡**ï¼Œå¯ä»¥åˆ†ä¸ºå‡½æ•°è£…é¥°å™¨å’Œç±»è£…é¥°å™¨ã€‚  
å½“ç»™ç±»ä½¿ç”¨çš„æ—¶å€™ è£…é¥°å™¨ç”¨äºåŠ¨æ€ä¿®æ”¹ç±»è¡Œä¸ºï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç±»ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç±»æˆ–ä¿®æ”¹åçš„ç±»ï¼Œç±»è£…é¥°å™¨å¯ä»¥æœ‰ä¸€ä¸‹åŠŸèƒ½ï¼š
- æ·»åŠ /ä¿®æ”¹ç±»çš„æ–¹æ³•æˆ–å±æ€§
- æ‹¦æˆªå®ä¾‹åŒ–è¿‡ç¨‹
- å®ç°å•ä¾‹æ¨¡å¼ã€æ—¥å¿—è®°å½•ã€æƒé™æ£€æŸ¥ç­‰åŠŸèƒ½


å¦å¤–æŒ‰ç…§è£…é¥°å™¨æœ¬èº«å®šä¹‰çš„æ–¹å¼ï¼Œå¯ä»¥åˆ†ä¸ºå‡½æ•°å½¢å¼å’Œç±»å½¢å¼ã€‚

<Tabs>

  <Tab title="ä¾‹å­ 1">
  ```py
    # å®šä¹‰ä¸€ä¸ªç±»è£…é¥°å™¨å‡½æ•°
    # æœ¬ä¾‹å­ç”¨äºæ¼”ç¤ºç±»è£…é¥°å™¨çš„ æ·»åŠ /ä¿®æ”¹ç±»çš„æ–¹æ³•æˆ–å±æ€§ åŠŸèƒ½
    def logger(cls):
        class Wrapper:
            def __init__(self, *args, **kwargs):
                self.wrapped = cls(*args, **kwargs)  # å®ä¾‹åŒ–åŸå§‹ç±»

            # æ‰©å±•è¢«ä¿®é¥°ç±»çš„åŠŸèƒ½
            def hi_logger(self):
                print(f"æˆ‘æ˜¯loggerè£…é¥°å™¨ï¼Œæˆ‘ç°å·²è¢«åº”ç”¨åˆ° {cls.__name__} ç±»ä¸Š")

            # ä»£ç†åŸå§‹ç±»çš„æ–¹æ³•
            def display(self):
                print(f"è°ƒç”¨ {cls.__name__}.display() å‰")
                self.wrapped.display()
                print(f"è°ƒç”¨ {cls.__name__}.display() å")

        return Wrapper  # è¿”å›åŒ…è£…åçš„ç±»

    # ä½¿ç”¨ç±»è£…é¥°å™¨
    @logger
    class Calculator:
        def display(self):
            print("è¿™æ˜¯ Calculator çš„ display æ–¹æ³•")

    obj = Calculator()
    obj.hi_logger()
    obj.display()
    ```
  </Tab>

  <Tab title="ä¾‹å­ 2">
    ```py
    class Logger:
        def __init__(self, func):
            self.func = func  # ä¿å­˜è¢«è£…é¥°çš„å‡½æ•°

        def __call__(self, *args):
            print(f"è°ƒç”¨å‡½æ•°: {self.func.__name__}")
            return self.func(*args)

    # åº”ç”¨åˆ°å‡½æ•°ä¸Š
    @Logger
    def say_hello(name):
        print(f"Hello, {name}!")

    say_hello("å°æ˜")
    ```
  </Tab>

  <Tab title="ä¾‹å­ 3">
    ```py
    class SingletonDecorator:
        def __init__(self, cls):
            self.cls = cls
            self.instance = None

        # __call__ä¸º python çš„ç‰¹æ®Šæ–¹æ³•ï¼Œç”¨äºå®šä¹‰å¯¹è±¡çš„å¯è°ƒç”¨è¡Œä¸º
        def __call__(self, *args, **kwargs):
            if self.instance is None:
                self.instance = self.cls(*args, **kwargs)
            return self.instance

    # åº”ç”¨åˆ°ç±»ä¸Š
    @SingletonDecorator
    class Database:
        def __init__(self):
            print("Database åˆå§‹åŒ–")

    db1 = Database()
    db2 = Database()
    print(db1 is db2)  # Trueï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªå®ä¾‹
    ```
  </Tab>
</Tabs>



## å †å ä½¿ç”¨

ä½ å¯ä»¥å°†å¤šä¸ªè£…é¥°å™¨å †å åœ¨ä¸€èµ·ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§ä»ä¸‹åˆ°ä¸Šçš„é¡ºåºä¾æ¬¡åº”ç”¨

```py
def decorator1(func):
    def wrapper():
        print("Decorator 1")
        func()
    return wrapper

def decorator2(func):
    def wrapper():
        print("Decorator 2")
        func()
    return wrapper

@decorator1
@decorator2
def say_hello():
    print("Hello!")

say_hello()
```

## å†…ç½®

Python æä¾›äº†ä¸€äº›å†…ç½®çš„è£…é¥°å™¨ï¼Œä¾‹å¦‚ï¼š

- @staticmethod: å°†æ–¹æ³•å®šä¹‰ä¸ºé™æ€æ–¹æ³•ï¼Œä¸éœ€è¦å®ä¾‹åŒ–ç±»å³å¯è°ƒç”¨ã€‚
- @classmethod: å°†æ–¹æ³•å®šä¹‰ä¸ºç±»æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»æœ¬èº«ï¼ˆé€šå¸¸å‘½åä¸º clsï¼‰ã€‚
- @property: å°†æ–¹æ³•è½¬æ¢ä¸ºå±æ€§ï¼Œä½¿å…¶å¯ä»¥åƒå±æ€§ä¸€æ ·è®¿é—®ã€‚

## å…¶å®ƒ

æˆ‘ä»¬ç»å¸¸çœ‹åˆ° `@xxx.xx` å½¢å¼çš„è£…é¥°å™¨ï¼Œå®é™…ä¸Šæ˜¯å±æ€§è®¿é—®çš„ç»“æœï¼Œå¯ä»¥åˆ†ä¸ºå‡ ç§æƒ…å†µï¼šÂ·
è¿™ç§ `@xxx.xx` å½¢å¼çš„è£…é¥°å™¨å®é™…ä¸Šéƒ½æ˜¯**å±æ€§è®¿é—®**çš„ç»“æœ

<Tabs>

  <Tab title="æ¨¡å—ä¸­çš„å‡½æ•°/ç±»ä½œä¸ºè£…é¥°å™¨">
    ```python
    # module_decorators.py
    class Logger:
        @staticmethod
        def log_calls(func):
            def wrapper(*args, **kwargs):
                print(f"Calling {func.__name__}")
                return func(*args, **kwargs)
            return wrapper

        @classmethod
        def time_it(cls, func):
            import time
            def wrapper(*args, **kwargs):
                start = time.time()
                result = func(*args, **kwargs)
                print(f"Execution time: {time.time() - start:.4f}s")
                return result
            return wrapper

    # å¦ä¸€ä¸ªæ–‡ä»¶ä½¿ç”¨
    import module_decorators

    @module_decorators.Logger.log_calls
    def my_func():
        pass

    @module_decorators.Logger.time_it
    def another_func():
        pass
    ```
  </Tab>

  <Tab title="å®ä¾‹çš„æ–¹æ³•ä½œä¸ºè£…é¥°å™¨">
    ```python
    class DecoratorFactory:
        def __init__(self, prefix="LOG"):
            self.prefix = prefix

        def decorator(self, func):
            def wrapper(*args, **kwargs):
                print(f"[{self.prefix}] {func.__name__} called")
                return func(*args, **kwargs)
            return wrapper

    # åˆ›å»ºå®ä¾‹
    factory = DecoratorFactory("DEBUG")

    # ä½¿ç”¨å®ä¾‹æ–¹æ³•ä½œä¸ºè£…é¥°å™¨
    @factory.decorator
    def test_function():
        print("Function executed")

    test_function()  # è¾“å‡º: test_function called \n Function executed
    ```
  </Tab>

  <Tab title="ç±»çš„å±æ€§ä½œä¸ºè£…é¥°å™¨">
    ```python
    class Registry:
        """è£…é¥°å™¨æ³¨å†Œè¡¨"""

        # ç±»å±æ€§æœ¬èº«å°±æ˜¯è£…é¥°å™¨
        registered = {}

        @classmethod
        def register(cls, name):
            """è¿”å›è£…é¥°å™¨å‡½æ•°"""
            def decorator(func):
                cls.registered[name] = func
                return func
            return decorator

        @classmethod
        def api(cls, version="v1"):
            """å¸¦å‚æ•°çš„è£…é¥°å™¨"""
            def decorator(func):
                func.api_version = version
                func.is_api = True
                return func
            return decorator

    # ä½¿ç”¨
    @Registry.register("user_login")
    @Registry.api("v2")
    def login():
        return "Login endpoint"

    print(Registry.registered)  # {'user_login': <function login>}
    print(login.api_version)    # v2
    ```
  </Tab>
</Tabs>
