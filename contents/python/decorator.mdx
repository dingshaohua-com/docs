---
title: è£…é¥°å™¨
---

è£…é¥°å™¨ï¼ˆdecoratorsï¼‰æ˜¯ Python ä¸­çš„ä¸€ç§é«˜çº§åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åŠ¨æ€åœ°ä¿®æ”¹å‡½æ•°æˆ–ç±»çš„è¡Œä¸ºã€‚
è£…é¥°å™¨æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°æˆ–ä¿®æ”¹åŸæ¥çš„å‡½æ•°ï¼šPython è£…é¥°å…è®¸åœ¨ä¸ä¿®æ”¹åŸæœ‰å‡½æ•°ä»£ç çš„åŸºç¡€ä¸Šï¼ŒåŠ¨æ€åœ°å¢åŠ æˆ–ä¿®æ”¹å‡½æ•°çš„åŠŸèƒ½ï¼Œè£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¥æ”¶å‡½æ•°ä½œä¸ºè¾“å…¥å¹¶è¿”å›ä¸€ä¸ªæ–°çš„åŒ…è£…è¿‡åçš„å‡½æ•°çš„å¯¹è±¡ã€‚

```mermaid
graph TD
    A[åŸå‡½æ•°] --> B[è£…é¥°å™¨ï¼ˆå‡½æ•°ï¼‰] --> C[æ–°å‡½æ•°]
```


è£…é¥°å™¨çš„è¯­æ³•ä½¿ç”¨ `@è£…é¥°å™¨å` æ¥åº”ç”¨åœ¨å‡½æ•°æˆ–æ–¹æ³•ä¸Šã€‚


## å…¥é—¨ä¾‹å­
æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªè£…é¥°å™¨å§

```python
def my_decorator(func):
    def wrapper():
        print("åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ")
        func()
        print("åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ")
    return wrapper
```
my_decorator æ˜¯ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•° func ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå†…éƒ¨å‡½æ•° wrapperï¼Œåœ¨ wrapper å‡½æ•°å†…éƒ¨ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€äº›é¢å¤–çš„æ“ä½œï¼Œç„¶åè°ƒç”¨åŸå§‹å‡½æ•° funcï¼Œå¹¶è¿”å›å…¶ç»“æœã€‚
* my_decorator æ˜¯è£…é¥°å™¨ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•° original_function ä½œä¸ºå‚æ•°ã€‚
* wrapper æ˜¯å†…éƒ¨å‡½æ•°ï¼Œå®ƒæ˜¯å®é™…ä¼šè¢«è°ƒç”¨çš„æ–°å‡½æ•°ï¼Œå®ƒåŒ…è£¹äº†åŸå§‹å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶åœ¨å…¶å‰åå¢åŠ äº†é¢å¤–çš„è¡Œä¸ºã€‚
* å½“æˆ‘ä»¬ä½¿ç”¨ @my_decorator å‰ç¼€åœ¨ xx_function å®šä¹‰å‰ï¼ŒPythonä¼šè‡ªåŠ¨å°† xx_function ä½œä¸ºå‚æ•°ä¼ é€’ç»™ my_decoratorï¼Œç„¶åå°†è¿”å›çš„ wrapper å‡½æ•°æ›¿æ¢æ‰åŸæ¥çš„ xx_functionã€‚


å¦‚ä¸‹å³å¯ä½¿ç”¨è£…é¥°å™¨
```python
@my_decorator
def say_hello():
    print("Hello!")

say_hello()

# æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
# åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ
# Hello!
# åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ
```

## å¸¦å‚æ•°çš„è£…é¥°å™¨
å¦‚æœåŸå‡½æ•°éœ€è¦å‚æ•°ï¼Œå¯ä»¥åœ¨è£…é¥°å™¨çš„ wrapper å‡½æ•°ä¸­ä¼ é€’å‚æ•°ï¼ˆå¦‚ä¸‹ä¾‹å­è¾“å‡ºç»“æœå’Œä¸Šè¾¹ä¸€æ ·ï¼‰
```python
def my_decorator(func):
    def wrapper(*args, **kwargs):
        print("åœ¨åŸå‡½æ•°ä¹‹å‰åšä¸€äº›æ“ä½œ")
        func(*args, **kwargs)
        print("åœ¨åŸå‡½æ•°ä¹‹ååšä¸€äº›æ“ä½œ")
    return wrapper

@my_decorator
def say_hello(msg):
    print(msg)

say_hello("Hello, World!")
```



è£…é¥°å™¨æœ¬èº«ä¹Ÿå¯ä»¥æ¥å—å‚æ•°ï¼Œæ­¤æ—¶éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ªå¤–å±‚å‡½æ•°ï¼ˆæ—¢è£…é¥°å™¨å·¥å‚ï¼‰æ¥æ¥æ”¶è¿™äº›å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼ˆğŸª†å¥—å¨ƒä¹ˆï¼‰ã€‚
```py
def repeat(num):
    def decorator(func):
        def wrapper(*args, **kwargs):
            for _ in range(num):
                func(*args, **kwargs)
        return wrapper
    return decorator

@repeat(2)
def say_hello(msg):
    print(msg)

say_hello("Hello, World!")

# æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
# Hello, World!
# Hello, World!
```



## è£…é¥°å™¨åˆ†ç±»

é™¤äº†ä¸Šè¾¹å…¥é—¨ä¾‹å­å‡½æ•°è£…é¥°å™¨å¤–ï¼ŒPython è¿˜æ”¯æŒç»™ç±»ä½¿ç”¨çš„è£…é¥°å™¨ã€‚   
ç±»è£…é¥°å™¨ç”¨äºåŠ¨æ€ä¿®æ”¹ç±»è¡Œä¸ºï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç±»ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç±»æˆ–ä¿®æ”¹åçš„ç±»ï¼Œç±»è£…é¥°å™¨å¯ä»¥æœ‰ä¸€ä¸‹åŠŸèƒ½ï¼š
* æ·»åŠ /ä¿®æ”¹ç±»çš„æ–¹æ³•æˆ–å±æ€§
* æ‹¦æˆªå®ä¾‹åŒ–è¿‡ç¨‹
* å®ç°å•ä¾‹æ¨¡å¼ã€æ—¥å¿—è®°å½•ã€æƒé™æ£€æŸ¥ç­‰åŠŸèƒ½


## è£…é¥°å™¨å®šä¹‰
è£…é¥°å™¨æœ‰ä¸¤ç§å¸¸è§å®šä¹‰å½¢å¼ï¼š
* å‡½æ•°å½¢å¼çš„ç±»è£…é¥°å™¨ï¼ˆæ¥æ”¶ç±»ä½œä¸ºå‚æ•°ï¼Œè¿”å›æ–°ç±»ï¼‰
* ç±»å½¢å¼çš„ç±»è£…é¥°å™¨ï¼ˆå®ç° __call__ æ–¹æ³•ï¼Œä½¿å…¶å¯è°ƒç”¨ï¼‰

è¿™ä¸¤ç§ä¸åŒå½¢å¼çš„å®šä¹‰éƒ½å¯ä»¥åº”ç”¨åˆ°ç±»æˆ–å‡½æ•°ä¸Šï¼


###  å‡½æ•°å½¢å¼
åº”ç”¨åˆ°å‡½æ•°ä¸Šçš„ä¾‹å­åœ¨ä¸Šè¾¹æåˆ°äº†ï¼Œè¿™é‡Œæ˜¯åº”ç”¨åˆ°ç±»ä¸Š
```py
# å®šä¹‰ä¸€ä¸ªç±»è£…é¥°å™¨å‡½æ•°ï¼ˆæœ¬ä¾‹å­ç”¨äºæ¼”ç¤ºç±»è£…é¥°å™¨çš„ æ·»åŠ /ä¿®æ”¹ç±»çš„æ–¹æ³•æˆ–å±æ€§ åŠŸèƒ½ï¼‰
def logger(cls):
    class Wrapper:
        def __init__(self, *args, **kwargs):
            self.wrapped = cls(*args, **kwargs)  # å®ä¾‹åŒ–åŸå§‹ç±»
       
        # æ‰©å±•è¢«ä¿®é¥°ç±»çš„åŠŸèƒ½
        def hi_logger(self):
            print(f"ä½ å¥½ï¼Œæˆ‘æ˜¯loggerè£…é¥°å™¨, æˆ‘ç°åœ¨å·²è¢«åº”ç”¨åˆ°äº† {cls.__name__} ç±»ä¸Š")

        # ä»£ç†åŸå§‹ç±»çš„æ–¹æ³•
        def display(self):
            print(f"è°ƒç”¨ {cls.__name__}.display() å‰")
            self.wrapped.display()
            print(f"è°ƒç”¨ {cls.__name__}.display() å")
   
    return Wrapper  # è¿”å›åŒ…è£…åçš„ç±»

# ä½¿ç”¨ç±»è£…é¥°å™¨
@logger
class Calculator:
    def display(self):
        print("è¿™æ˜¯ Calculator çš„ display æ–¹æ³•")

obj = Calculator()
obj.hi_logger()
obj.display()
```

###  ç±»å½¢å¼
åº”ç”¨åˆ°å‡½æ•°ä¸Š
```py
class Logger:
    def __init__(self, func):
        self.func = func  # ä¿å­˜è¢«è£…é¥°çš„å‡½æ•°
    
    def __call__(self, *args):
        print(f"è°ƒç”¨å‡½æ•°: {self.func.__name__}")
        return self.func(*args)

@Logger
def say_hello(name):
    print(f"Hello, {name}!")

say_hello("å°æ˜")
```

åº”ç”¨åˆ°ç±»ä¸Š
```py
class SingletonDecorator:
    def __init__(self, cls):
        self.cls = cls
        self.instance = None
   
    # __call__ä¸º python çš„ç‰¹æ®Šæ–¹æ³•ï¼Œç”¨äºå®šä¹‰å¯¹è±¡çš„å¯è°ƒç”¨è¡Œä¸º
    def __call__(self, *args, **kwargs): 
        if self.instance is None:
            self.instance = self.cls(*args, **kwargs)
        return self.instance

@SingletonDecorator
class Database:
    def __init__(self):
        print("Database åˆå§‹åŒ–")

db1 = Database()
db2 = Database()
print(db1 is db2)  # Trueï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªå®ä¾‹
```

## å¤šä¸ªè£…é¥°å™¨çš„å †å ä½¿ç”¨
ä½ å¯ä»¥å°†å¤šä¸ªè£…é¥°å™¨å †å åœ¨ä¸€èµ·ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§ä»ä¸‹åˆ°ä¸Šçš„é¡ºåºä¾æ¬¡åº”ç”¨
```py
def decorator1(func):
    def wrapper():
        print("Decorator 1")
        func()
    return wrapper

def decorator2(func):
    def wrapper():
        print("Decorator 2")
        func()
    return wrapper

@decorator1
@decorator2
def say_hello():
    print("Hello!")

say_hello()
```

## å†…ç½®è£…é¥°å™¨
Python æä¾›äº†ä¸€äº›å†…ç½®çš„è£…é¥°å™¨ï¼Œä¾‹å¦‚ï¼š
* @staticmethod: å°†æ–¹æ³•å®šä¹‰ä¸ºé™æ€æ–¹æ³•ï¼Œä¸éœ€è¦å®ä¾‹åŒ–ç±»å³å¯è°ƒç”¨ã€‚
* @classmethod: å°†æ–¹æ³•å®šä¹‰ä¸ºç±»æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»æœ¬èº«ï¼ˆé€šå¸¸å‘½åä¸º clsï¼‰ã€‚
* @property: å°†æ–¹æ³•è½¬æ¢ä¸ºå±æ€§ï¼Œä½¿å…¶å¯ä»¥åƒå±æ€§ä¸€æ ·è®¿é—®ã€‚


## å‘½åç©ºé—´
ç§ @xxx.xx å½¢å¼çš„è£…é¥°å™¨å®é™…ä¸Šæ˜¯å±æ€§è®¿é—®çš„ç»“æœï¼Œå¯ä»¥åˆ†ä¸ºå‡ ç§æƒ…å†µ
è¿™ç§ `@xxx.xx` å½¢å¼çš„è£…é¥°å™¨å®é™…ä¸Šéƒ½æ˜¯**å±æ€§è®¿é—®**çš„ç»“æœ

### æ¨¡å—ä¸­çš„å‡½æ•°/ç±»ä½œä¸ºè£…é¥°å™¨

```python
# module_decorators.py
class Logger:
    @staticmethod
    def log_calls(func):
        def wrapper(*args, **kwargs):
            print(f"Calling {func.__name__}")
            return func(*args, **kwargs)
        return wrapper

    @classmethod
    def time_it(cls, func):
        import time
        def wrapper(*args, **kwargs):
            start = time.time()
            result = func(*args, **kwargs)
            print(f"Execution time: {time.time() - start:.4f}s")
            return result
        return wrapper

# å¦ä¸€ä¸ªæ–‡ä»¶ä½¿ç”¨
import module_decorators

@module_decorators.Logger.log_calls
def my_func():
    pass

@module_decorators.Logger.time_it
def another_func():
    pass
```

### å®ä¾‹çš„æ–¹æ³•ä½œä¸ºè£…é¥°å™¨

```python
class DecoratorFactory:
    def __init__(self, prefix="LOG"):
        self.prefix = prefix
    
    def decorator(self, func):
        def wrapper(*args, **kwargs):
            print(f"[{self.prefix}] {func.__name__} called")
            return func(*args, **kwargs)
        return wrapper

# åˆ›å»ºå®ä¾‹
factory = DecoratorFactory("DEBUG")

# ä½¿ç”¨å®ä¾‹æ–¹æ³•ä½œä¸ºè£…é¥°å™¨
@factory.decorator
def test_function():
    print("Function executed")

test_function()  # è¾“å‡º: [DEBUG] test_function called \n Function executed
```

### ç±»çš„å±æ€§ä½œä¸ºè£…é¥°å™¨

```python
class Registry:
    """è£…é¥°å™¨æ³¨å†Œè¡¨"""
    
    # ç±»å±æ€§æœ¬èº«å°±æ˜¯è£…é¥°å™¨
    registered = {}
    
    @classmethod
    def register(cls, name):
        """è¿”å›è£…é¥°å™¨å‡½æ•°"""
        def decorator(func):
            cls.registered[name] = func
            return func
        return decorator
    
    @classmethod
    def api(cls, version="v1"):
        """å¸¦å‚æ•°çš„è£…é¥°å™¨"""
        def decorator(func):
            func.api_version = version
            func.is_api = True
            return func
        return decorator

# ä½¿ç”¨
@Registry.register("user_login")
@Registry.api("v2")
def login():
    return "Login endpoint"

print(Registry.registered)  # {'user_login': <function login>}
print(login.api_version)    # v2
```
