---
title: å¤¹å…·
---

å‡è®¾è¯´æˆ‘ä»¬è¦æµ‹è¯•è¿™ä¸ªè®¡ç®—å™¨

```tsx
class Calculator:
    def add(self, a, b):
        return a + b
    def subtract(self, a, b):
        return a - b
    
def test_add():
    calculator = Calculator()        # âŒ æ¯ä¸ªæµ‹è¯•éƒ½é‡å¤åˆ›å»º
    assert calculator.add(1, 2) == 3

def test_subtract():
    calculator = Calculator()        # âŒ é‡å¤ä»£ç 
    assert calculator.subtract(5, 3) == 2
```

è®¡ç®—å™¨è¿™ä¸ªå¯¹è±¡è¦é¢‘ç¹åˆ›å»ºï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å¤¹å…·æä¾›è¦æµ‹è¯•çš„å¯¹è±¡ã€‚

```tsx
class Calculator:
    def add(self, a, b):
        return a + b
    def subtract(self, a, b):
        return a - b

# ç›¸å½“äº inject æ³¨å…¥å¯¹è±¡ï¼Œåªä¸è¿‡æ˜¯è‡ªåŠ¨æ¨å¯¼éœ€è¦æ³¨å…¥ç±»å‹
@pytest.fixture 
def calculator():                    # âœ… åˆ›å»ºé€»è¾‘å†™ä¸€æ¬¡
    return Calculator()

def test_add(calculator):            # âœ… è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€é‡å¤åˆ›å»º
    assert calculator.add(1, 2) == 3

def test_subtract(calculator):       # âœ… å¤ç”¨åŒä¸€ä¸ªå¤¹å…·
    assert calculator.add(5, -3) == 2
```

å¤¹å…·ï¼ˆFixtureï¼‰çš„ä¸»è¦ä½œç”¨å°±æ˜¯**æä¾›æµ‹è¯•å¯¹è±¡**å’Œ**å‡†å¤‡æµ‹è¯•ç¯å¢ƒ**ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

---

## å¤¹å…·çš„æ ¸å¿ƒä½œç”¨ï¼šæä¾›æµ‹è¯•å¯¹è±¡

### åŸºæœ¬ç”¨æ³•ï¼šåˆ›å»ºæµ‹è¯•å¯¹è±¡

```python
import pytest

class Calculator:
    def add(self, a, b):
        return a + b

@pytest.fixture
def calculator():                    # â† æä¾› Calculator å®ä¾‹
    return Calculator()              # åˆ›å»ºæµ‹è¯•å¯¹è±¡

def test_add(calculator):            # â† è‡ªåŠ¨è·å¾— calculator å¯¹è±¡
    assert calculator.add(1, 2) == 3

```

---

## å¤¹å…·æä¾›çš„ä¸ä»…ä»…æ˜¯"å¯¹è±¡"

### 1. **æä¾›æ•°æ®å¯¹è±¡**

```python
@pytest.fixture
def sample_user():                   # â† æä¾›æ•°æ®å¯¹è±¡
    return {"name": "Alice", "age": 30, "email": "alice@example.com"}

def test_user_creation(sample_user):
    assert sample_user["name"] == "Alice"

```

### 2. **æä¾›èµ„æºè¿æ¥**

```python
@pytest.fixture
def database_connection():           # â† æä¾›èµ„æºè¿æ¥
    conn = connect_to_test_database()
    yield conn
    conn.close()  # æµ‹è¯•åæ¸…ç†

def test_database_query(database_connection):
    result = database_connection.query("SELECT * FROM users")
    assert len(result) == 0

```

### 3. **æä¾›é…ç½®ä¿¡æ¯**

```python
@pytest.fixture
def app_config():                    # â† æä¾›é…ç½®ä¿¡æ¯
    return {
        "debug": True,
        "database_url": "sqlite:///:memory:",
        "secret_key": "test-key"
    }

def test_app_initialization(app_config):
    app = create_app(app_config)
    assert app.config["debug"] is True

```

### 4. **æä¾›æ¨¡æ‹Ÿå¯¹è±¡**

```python
@pytest.fixture
def mock_http_client():              # â† æä¾›æ¨¡æ‹Ÿå¯¹è±¡
    mock_client = Mock()
    mock_client.get.return_value = {"status": "success"}
    return mock_client

def test_api_call(mock_http_client):
    result = call_api(mock_http_client)
    assert result["status"] == "success"

```

---

## ä¸ºä»€ä¹ˆç”¨å¤¹å…·æä¾›å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ›å»ºï¼Ÿ

### é—®é¢˜ï¼šç›´æ¥åˆ›å»ºï¼ˆä¸æ¨èï¼‰

```python
def test_add():
    calculator = Calculator()        # âŒ æ¯ä¸ªæµ‹è¯•éƒ½é‡å¤åˆ›å»º
    assert calculator.add(1, 2) == 3

def test_subtract():
    calculator = Calculator()        # âŒ é‡å¤ä»£ç 
    assert calculator.add(5, -3) == 2

```

### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å¤¹å…·ï¼ˆæ¨èï¼‰

```python
@pytest.fixture
def calculator():                    # âœ… åˆ›å»ºé€»è¾‘å†™ä¸€æ¬¡
    return Calculator()

def test_add(calculator):            # âœ… è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€é‡å¤åˆ›å»º
    assert calculator.add(1, 2) == 3

def test_subtract(calculator):       # âœ… å¤ç”¨åŒä¸€ä¸ªå¤¹å…·
    assert calculator.add(5, -3) == 2

```

---

## å¤¹å…·çš„è¿›é˜¶ç”¨æ³•

### 1. **å¸¦æ¸…ç†çš„å¤æ‚å¯¹è±¡**

```python
@pytest.fixture
def temporary_file():                # â† æä¾›æ–‡ä»¶å¯¹è±¡ï¼Œè‡ªåŠ¨æ¸…ç†
    file = tempfile.NamedTemporaryFile()
    yield file
    file.close()  # æµ‹è¯•åè‡ªåŠ¨æ¸…ç†

def test_file_operations(temporary_file):
    temporary_file.write(b"test data")
    temporary_file.seek(0)
    assert temporary_file.read() == b"test data"

```

### 2. **å¸¦å‚æ•°çš„å¯¹è±¡åˆ›å»º**

```python
@pytest.fixture
def calculator_with_precision():
    def _create_calculator(precision):
        calc = Calculator()
        calc.set_precision(precision)
        return calc
    return _create_calculator        # â† è¿”å›å·¥å‚å‡½æ•°

def test_precision(calculator_with_precision):
    calc = calculator_with_precision(2)  # åˆ›å»ºæŒ‡å®šç²¾åº¦çš„è®¡ç®—å™¨
    result = calc.add(1.111, 2.222)
    assert result == 3.33

```

### 3. **å…±äº«å¯¹è±¡ï¼ˆå•ä¾‹ï¼‰**

```python
@pytest.fixture(scope="session")     # â† æ•´ä¸ªæµ‹è¯•ä¼šè¯åªåˆ›å»ºä¸€æ¬¡
def shared_database():
    db = create_expensive_database_connection()
    yield db
    db.close()

def test_user_operations(shared_database):  # â† æ‰€æœ‰æµ‹è¯•å…±äº«åŒä¸€ä¸ªè¿æ¥
    # ä½¿ç”¨å…±äº«æ•°æ®åº“è¿æ¥
    pass

```

---

## æ€»ç»“

**æ˜¯çš„ï¼Œå¤¹å…·çš„ä¸»è¦ä½œç”¨å°±æ˜¯æä¾›æµ‹è¯•å¯¹è±¡**ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **ç®€å•å¯¹è±¡**ï¼šCalculatorã€User ç­‰ä¸šåŠ¡å¯¹è±¡
- âœ… **æ•°æ®å¯¹è±¡**ï¼šæµ‹è¯•æ•°æ®ã€é…ç½®ä¿¡æ¯
- âœ… **èµ„æºå¯¹è±¡**ï¼šæ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥
- âœ… **æ¨¡æ‹Ÿå¯¹è±¡**ï¼šMockã€Stub ç­‰æµ‹è¯•æ›¿èº«

**ä¼˜åŠ¿**ï¼š

- ğŸ¯ **ä»£ç å¤ç”¨**ï¼šé¿å…åœ¨æ¯ä¸ªæµ‹è¯•ä¸­é‡å¤åˆ›å»ºé€»è¾‘
- ğŸ¯ **ä¾èµ–æ³¨å…¥**ï¼šè‡ªåŠ¨ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
- ğŸ¯ **æµ‹è¯•éš”ç¦»**ï¼šç¡®ä¿æ¯ä¸ªæµ‹è¯•æœ‰å¹²å‡€çš„ç¯å¢ƒ
- ğŸ¯ **èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†æµ‹è¯•èµ„æº

æ‰€ä»¥ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼š**å¤¹å…·å°±æ˜¯æµ‹è¯•å¯¹è±¡çš„æä¾›è€…**ï¼

## è‡ªåŠ¨æ‰§è¡Œ

`autouse=True`Â ç¡®å®è®©å¤¹å…·**ç‹¬ç«‹è‡ªåŠ¨æ‰§è¡Œ**ï¼Œä¸å†ä¾èµ–äºæ‰‹åŠ¨åœ¨æµ‹è¯•ç”¨ä¾‹çš„æ˜¾å¼è§¦å‘ï¼ˆä½†æ˜¯å¿…é¡»è‡³å°‘å­˜åœ¨ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰ã€‚

```tsx
@pytest.fixture(autouse=True)
def calculator():
    print('æ‰§è¡Œäº†')

def test_add():
    pass
```

é€šå¸¸ç”¨äºè®°å½•æ—¥å¿—ï¼Œé“¾æ¥æ•°æ®åº“ç­‰ç­‰ï¼

## å¤¹å…·è‡ªèº«å‚æ•°

```tsx
import pytest

class Calculator:
    def add(self, a, b):
        print("æ‰§è¡ŒåŠ æ³•äº†ï¼Œè¿™æ˜¯ä¼ å…¥çš„å‚æ•°", a, b)
        return a + b

@pytest.fixture
def calculator(request):
     # request åŒ…å«äº†æµ‹è¯•çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
    print(f"æµ‹è¯•å‡½æ•°(è°è°ƒç”¨äº†æˆ‘): {request.function.__name__}")
    print(f"æµ‹è¯•æ–‡ä»¶(åœ¨å“ªä¸ªæ–‡ä»¶ä¸­): {request.module.__name__}")
    print(f"å¤¹å…·ä½œç”¨åŸŸ: {request.scope}")
    return Calculator()

def test_add(calculator):
    res = calculator.add(1, 2)
    print('Result:', res)
    assert res == 3
```

 pytest å¤¹å…·ç¡®å®å¯ä»¥è¢«æ³¨å…¥å‚æ•°ï¼Œè¿™æ˜¯å®ƒä¸€ä¸ªéå¸¸å¼ºå¤§çš„ç‰¹æ€§ï¼

---

## å¤¹å…·å‚æ•°æ³¨å…¥çš„ä¸¤ç§æ–¹å¼

### 1. **ä½¿ç”¨ `request` å‚æ•°ï¼ˆæœ€å¸¸ç”¨ï¼‰**

`request` æ˜¯ä¸€ä¸ªå†…ç½®çš„ fixtureï¼Œæä¾›äº†æµ‹è¯•è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

```python
import pytest

@pytest.fixture
def server(request):
    # request åŒ…å«äº†æµ‹è¯•çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
    print(f"æµ‹è¯•å‡½æ•°: {request.function.__name__}")
    print(f"æµ‹è¯•æ–‡ä»¶: {request.module.__name__}")
    print(f"å¤¹å…·ä½œç”¨åŸŸ: {request.scope}")

    # å¯ä»¥è®¿é—®æµ‹è¯•æ ‡è®°
    if "slow" in request.keywords:
        print("è¿™æ˜¯ä¸€ä¸ªæ…¢é€Ÿæµ‹è¯•ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†")

    return "server_instance"

def test_something(server):
    assert server == "server_instance"

```

### 2. **ä½¿ç”¨å…¶ä»– fixtureï¼ˆå¤¹å…·ä¾èµ–ï¼‰**

```python
import pytest

@pytest.fixture
def database_config():
    return {"host": "localhost", "port": 5432}

@pytest.fixture
def server(database_config):  # â† æ³¨å…¥å…¶ä»– fixture
    # ä½¿ç”¨ database_config æ¥é…ç½® server
    host = database_config["host"]
    port = database_config["port"]
    return f"server://{host}:{port}"

def test_server_connection(server):
    assert server == "server://localhost:5432"

```

---

## `request` fixture çš„è¯¦ç»†ä¿¡æ¯

### å¸¸ç”¨å±æ€§ï¼š

```python
@pytest.fixture
def smart_fixture(request):
    print(f"ğŸ“ æµ‹è¯•å‡½æ•°: {request.function.__name__}")
    print(f"ğŸ“ æµ‹è¯•æ¨¡å—: {request.module.__name__}")
    print(f"ğŸ¯ å¤¹å…·ä½œç”¨åŸŸ: {request.scope}")  # function, class, module, session
    print(f"ğŸ·ï¸ æµ‹è¯•æ ‡è®°: {request.keywords}")  # pytest.mark æ ‡è®°
    print(f"ğŸ“¦ æµ‹è¯•ç±»: {request.cls}")  # å¦‚æœæ˜¯ç±»ä¸­çš„æµ‹è¯•
    print(f"ğŸ”§ å¤¹å…·åç§°: {request.fixturename}")

    # è·å–å¤¹å…·çš„ç¼“å­˜å€¼ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
    if hasattr(request, "config"):
        cache = request.config.cache
        cached_data = cache.get("expensive_data", None)

    return "fixture_result"

```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ ¹æ®æµ‹è¯•æ ‡è®°åŠ¨æ€é…ç½®

```python
@pytest.fixture
def database(request):
    # æ ¹æ®æµ‹è¯•æ ‡è®°é€‰æ‹©ä¸åŒçš„æ•°æ®åº“
    if request.node.get_closest_marker("integration"):
        # é›†æˆæµ‹è¯•ç”¨çœŸå®æ•°æ®åº“
        db = connect_to_production_db()
    else:
        # å•å…ƒæµ‹è¯•ç”¨å†…å­˜æ•°æ®åº“
        db = connect_to_memory_db()

    yield db
    db.close()

@pytest.mark.integration
def test_integration(database):
    # ä½¿ç”¨çœŸå®æ•°æ®åº“
    result = database.query("complex query")
    assert result is not None

def test_unit(database):
    # ä½¿ç”¨å†…å­˜æ•°æ®åº“
    result = database.query("simple query")
    assert result == []

```

### åœºæ™¯2ï¼šè®¿é—®æµ‹è¯•å‚æ•°

```python
@pytest.fixture
def configured_server(request):
    # å¦‚æœæµ‹è¯•æœ‰ç‰¹å®šçš„é…ç½®å‚æ•°ï¼Œä½¿ç”¨å®ƒ
    server_type = getattr(request, "param", "default")  # è·å–å‚æ•°åŒ–å‚æ•°
    return create_server(server_type)

@pytest.mark.parametrize("configured_server", ["http", "https"], indirect=True)
def test_protocols(configured_server):
    # configured_server ä¼šæ ¹æ®å‚æ•°åˆ›å»ºä¸åŒçš„æœåŠ¡å™¨
    assert configured_server.protocol in ["http", "https"]

```

### åœºæ™¯3ï¼šæ¡ä»¶æ€§å¤¹å…·

```python
@pytest.fixture
def expensive_resource(request):
    # åªæœ‰éœ€è¦æ—¶æ‰åˆ›å»ºæ˜‚è´µèµ„æº
    if "needs_expensive" in request.keywords:
        resource = create_expensive_resource()
        yield resource
        resource.cleanup()
    else:
        yield None

@pytest.mark.needs_expensive
def test_with_expensive_resource(expensive_resource):
    assert expensive_resource is not None

def test_without_expensive_resource(expensive_resource):
    assert expensive_resource is None  # ä¸ä¼šåˆ›å»ºæ˜‚è´µèµ„æº

```

---

## ä½ çš„ä¾‹å­è§£æ

```python
@pytest.fixture(scope="module", autouse=True)
def server(request):  # â† request æ˜¯ pytest å†…ç½®çš„ fixture
    # è¿™é‡Œå¯ä»¥è®¿é—®è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
    print(f"ä¸ºæ¨¡å— {request.module.__name__} è®¾ç½®æœåŠ¡å™¨")

    server = start_test_server()

    # æ·»åŠ æ¸…ç†é€»è¾‘
    def cleanup():
        server.shutdown()

    request.addfinalizer(cleanup)  # æ³¨å†Œæ¸…ç†å‡½æ•°
    return server

```

**`request` åœ¨è¿™é‡Œçš„ä½œç”¨**ï¼š

- è·å–æ¨¡å—ä¿¡æ¯
- æ³¨å†Œæ¸…ç†å›è°ƒ
- è®¿é—®æµ‹è¯•ä¸Šä¸‹æ–‡

---

## æ€»ç»“

**æ˜¯çš„ï¼Œpytest å¤¹å…·å¯ä»¥è¢«æ³¨å…¥å‚æ•°ï¼** ä¸»è¦æœ‰ï¼š

1. **`request` fixture**ï¼šè·å–æµ‹è¯•ä¸Šä¸‹æ–‡ä¿¡æ¯
2. **å…¶ä»– fixture**ï¼šå®ç°å¤¹å…·ä¹‹é—´çš„ä¾èµ–
3. **å‚æ•°åŒ–å‚æ•°**ï¼šé€šè¿‡ `request.param` è®¿é—®

è¿™è®© pytest å¤¹å…·å˜å¾—æå…¶çµæ´»å’Œå¼ºå¤§ï¼Œå¯ä»¥æ ¹æ®æµ‹è¯•çš„ä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´è¡Œä¸ºï¼